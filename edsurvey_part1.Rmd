---
title: "Analyzing NAEP/TIMSS Data with Direct Estimation using the R packages EdSurvey and Dire"
author: |
 | <strong>Team Leads</strong>: Ting Zhang & Paul Bailey <br><strong>NCES Lead</strong>: Emmanuel Sikali<br><strong>Development Team</strong>: Michael Lee, Huade Huo, Thomas Fink, Sinan Yavuz, Khaya Klanot, & Sun-Joo Lee<br><strong>Quality Control Team</strong>: Michael Cohen, Yuqi Liao, Charles Blankenship, & Thanh Mai
date: "April 2022"
output:
  xaringan::moon_reader:
    css: ["naep-theme.css"]
    chakra: libs/remark-latest.min.js
    lib_dir: libs
    seal: false
    self_contained: true
    scroll: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

class: inverse, title-slide

<hr>

Analyzing NAEP/TIMSS Data with Direct Estimation using the R packages EdSurvey and Dire
========================================================

<hr>
<br>

**Presenters**: Paul Bailey, Ting Zhang, Michael Lee, & Sinan Yavuz


_April 2022_

.logo[
```{r airLogo, echo=FALSE, out.width='80%', out.height='80%'}
knitr::include_graphics('presentationFigures/naepLogo.png')
```
]

```{r, include=FALSE}
source("CreatingRscriptsFromRmd.R")
```

---

Workshop Goal
========================================================
<br>
## Provide participants with an overview of the methods used to analyze national and international large-scale assessment data using the R package `EdSurvey` and `Dire`.

---

Outline of EdSurvey Workshop
========================================================

1. Introduction to R, EdSurvey, and Dire

2. Data Processing and Data Manipulation

3. Hands-on practice
  
4. Descriptive statistics

5. Hands-on practice

6. Direct estimation with EdSurvey and Dire

7. Hands-on practice


---

Course Materials
========================================================

Available here: [2022 NCME Training Content](https://github.com/American-Institutes-for-Research/2022-NCME-EdSurvey-Training/)

```{r, echo=FALSE}
knitr::include_graphics('presentationFigures/workshopContent.PNG')
```

---
class: inverse, section-slide

Introduction to R, EdSurvey, and Dire
========================================================
<hr class="sectionSlide">
.logoSection[
```{r, echo=FALSE, out.width='80%', out.height='80%'}
knitr::include_graphics('presentationFigures/naepLogo.png')
```
]

---

Why R?
========================================================

```{r echo=FALSE}
options(width = 130)
```

1. **Free:** users can legally use and edit R package code

2. **Extensible:** large variety of contributed packages that expand its functionality

3. **Reproducible:** automated data analysis

4. **Designed by and for researchers:** robust ecosystem to translate data into analyses, visualizations, and summary reports with one software


---

Why EdSurvey?
========================================================
  
```{r echo=FALSE}
options(width = 130)
```

1. **One-stop shop** for data downloading, processing, manipulation and analysis of survey data.

2. **Automated**: Weights and complex sampling design calculations are automated following standard OECD methodology.

3. **Simple**: e.g., a regression with 80 replicate weights requires only a few lines of code.

4. **Flexible**: You can use functions that rely on EdSurvey methods or get the data and use traditional R.

5. **Minimizes memory footprint** by only reading in required data.



---

Why Dire?
========================================================
  
```{r echo=FALSE}
options(width = 130)
```

1. **Wow**: Assessments with the matrix booklet design require special considerations in data analysis, e.g., IRT and multiple imputation for item responses. `Dire` provides direct estimation functions that handles analyses of these assessment data properly.

2. **Efficient**: Studentsâ€™ latent proficiency distribution, as well as reporting group difference parameters, are estimated on the fly.

3. **Plausible Values Generation**: No need to rely on testing companies. Plausible values can be generated from the user-defined MML model and used for further analysis.

4. **Expanding Research Scope**: Providing the opportunity for researchers to link administrative data, aggregate data about a community from official statistics, or data from multiple surveys to open up new research questions.

---

class: explainerA

Basic R Infrastructure
========================================================

---

class: explainerB

Basic R Infrastructure
========================================================

---

class: explainerC

Basic R Infrastructure
========================================================

---

class: explainerD

Basic R Infrastructure
========================================================

---
class: inverse, section-slide

Get to Know the R Environment
========================================================
<hr class="sectionSlide">
.logoSection[
```{r, echo=FALSE, out.width='80%', out.height='80%'}
knitr::include_graphics('presentationFigures/naepLogo.png')
```
]

---

Follow Along - R Scripts
========================================================

```{r, echo=FALSE}
knitr::include_graphics('presentationFigures/rstudioScript.png')
```

Follow along in [edsurvey_part1_Script.R](edsurvey_part2_Script.R)

---

Notes About Using R
========================================================

- Highlight , `ctrl` + `enter` executes code to console

- Comment character is a hash
```{r quickcomment}
# this line is not executed
```

- Variables are assigned with an equals or `<-`
```{r x12}
x <- 12
x
```

- In file names on Windows use a forward slash
  - `C:/`
  
- R is case sensitive!
```{r caseSensitive, error=TRUE}
j <- 12
J
```

---

Notes About Using R (cont)
========================================================

- Any command can be input with a question mark preceding it to open the help guide

```{r mean, eval=FALSE}
?mean
```

- Use the up arrow on your keyboard to copy your previous lines of code

- Try tab completion, type, "data" then hit the tab key

```{r, echo=FALSE}
knitr::include_graphics('presentationFigures/dataTab.png')
```

---

Using R Functions
========================================================

- `c()` function combines values, separated by a comma, into a vector

```{r vector}
colors <- c("red", "green", "blue")
colors
numbers <- c(1, 2, 3)
numbers
```

- In the `EdSurvey` package we'll use vectors to combine the names of variables in our analyses

---

Using R Functions
========================================================

- Arguments can be explicitly or implicitly named

```{r meanExample}
mean(x = numbers)
mean(numbers)
```

- Arguments are separated by commas

```{r mean2.png, echo=FALSE, out.width='30%', out.height='30%'}
knitr::include_graphics('presentationFigures/meanArgs2.png')
```


---

Installing the EdSurvey Package
========================================================

- After opening up RStudio, run the following scripts in the console to download and initialize the `EdSurvey` package:

```{r beta testers, message=FALSE, eval=FALSE}
# to install the package
install.packages("EdSurvey")
```

```{r set_options, message=FALSE, echo=FALSE, include=FALSE}
options(scipen=999)
options(useFancyQuotes = FALSE)
```

```{r load library, message=FALSE, eval=TRUE, warning = FALSE}
# to load the package
library(EdSurvey)
```

---

Learning EdSurvey
========================================================

- Reading vignettes provided in training materials

```{r browse, eval=FALSE}
vignette("introduction", package="EdSurvey")
```  

- R help
```{r rhelp1, eval=FALSE}
help(package = "EdSurvey")
```

- [EdSurvey eBook](https://naep-research.airprojects.org/Portals/0/EdSurvey_A_Users_Guide/_book/index.html)

- [EdSurvey Website](https://www.air.org/project/nces-data-r-project-edsurvey)

- [EdSurvey Github](https://github.com/American-Institutes-for-Research/EdSurvey)

- [NAEP Data Training workshop](http://naep-research.airprojects.org/Opportunities/Training)

---

Self-Reflection - R Functions
========================================================

**Ask yourself:** What are the arguments of the function `readNAEP()`? What are some examples of acceptable values for each argument?

---

Self-Reflection - R Functions
========================================================

`readNAEP()` arguments, from R documentation (*type `?readNAEP` in the console*)


```{r, echo=FALSE}
knitr::include_graphics('presentationFigures/readNAEP.png')
```

---

class: inverse, section-slide

Data Processing
========================================================
<hr class="sectionSlide">
.logoSection[
```{r, echo=FALSE, out.width='80%', out.height='80%'}
knitr::include_graphics('presentationFigures/naepLogo.png')
```
]

---

Data Processing
========================================================

- First, read in the publicly available NAEP data from `NAEPprimer`

```{r read in data, message=FALSE}
sdf <- readNAEP(system.file("extdata/data", "M36NT2PM.dat", package = "NAEPprimer"))
```

```{r sdf.png, echo=FALSE, out.width='75%', out.height='75%'}
knitr::include_graphics('presentationFigures/sdf.png')
```

- How long did that take?

---

Data Processing
========================================================

- Can also read in other restricted-use NAEP data by naming the file location

```{r read in actual data,eval=FALSE}
math17 <- readNAEP("//path_to_directory/Data/M48NT2AT.dat")
```

- The first character indicates the subject - `M` (Math)
- The second and third characters indicate the NAEP year - `48` (2017 - 1969 = 48)
- The fourth character indicates the component - `N` (National)
- The fifth character indicates the type of data - `T` (Student)
- The sixth character indicates the grade cohort - `2` (8th)
- The seventh and eighth characters indicate the sample - `AT` (Main NAEP)

---

Data Processing
========================================================

NOTE: the dat file requires its intact data folder directory in order to be read in correctly; containing both the student and school level files to merge data

```{r, echo=FALSE, out.width='60%', out.height='60%'}
knitr::include_graphics('presentationFigures/dataPathway2.png')
```

---

class: inverse, section-slide

Meet Your Data
========================================================
<hr class="sectionSlide">
.logoSection[
```{r, echo=FALSE, out.width='80%', out.height='80%'}
knitr::include_graphics('presentationFigures/naepLogo.png')
```
]



---

Quick Terminology Notes
========================================================

The `edsurvey.data.frame` class stores information about survey data via a data connection, which allows for:
  - Correct calculation of relevant statistics.
  - Limited working memory usage.

<br>

**`_____SDF`**

The Edsurvey package uses the acronym `SDF` in the names of several functions to signify their relationship to **S**urvey **D**ata **F**rames.


---

Quick Terminology Notes
========================================================

The `edsurvey.data.frame.list` class stores a list of `edsurvey.data.frame` objects.

  - The list can be passed to the analysis functions, and a result list will be returned.
  - A list can store both `cov` (covariants) and `labels` arguments. For example, the 'year' and 'country' might vary across the `edsurvey.data.frame`s in the list.
  - `edsurvey.data.frame.lists` can also be constructed manually.  See the `?edsurvey.data.frame.list` documentation.


---

class: EdSurveyWorkflowBlank

One-stop Shop for NCES Survey Analysis
========================================================

---

One-stop Shop for NCES Survey Analysis
========================================================

```{r, echo=FALSE, out.width='60%', out.height='60%'}
knitr::include_graphics('presentationFigures/workflow1.png')
```

- Install R and EdSurvey
- Download and read-in data

_Example functions_:
 - `readTIMSS`
 - `downloadTIMSS`

---

One-stop Shop for NCES Survey Analysis
========================================================

```{r, echo=FALSE, out.width='60%', out.height='60%'}
knitr::include_graphics('presentationFigures/workflow2.png')
```

- *Explore*: explore the codebook, see the variables with plausible values, see weights
- *Search*: search variables
- *Expand*: see variable levels, tabulate response percentages, see assessment scores by response category, summarize continuous variables

_Example functions_:
- `showCodebook`, `showPlausibleValues`, `showWeights`
- `searchSDF`, `levelsSDF`
- `summary2`, `edsurveyTable`


---

One-stop Shop for NCES Survey Analysis
========================================================

```{r, echo=FALSE, out.width='60%', out.height='60%'}
knitr::include_graphics('presentationFigures/workflow3.png')
```

In *EdSurvey*: Clean and manipulate data with built-in subset and recode features.

In *R*: Extract and manipulate data as a data frame (for experienced users)

_Example functions_:
- `subset`
- `rename.sdf`, `recode.sdf`
- `getData`, `rebindAttributes`

---

One-stop Shop for NCES Survey Analysis
========================================================

```{r, echo=FALSE, out.width='60%', out.height='60%'}
knitr::include_graphics('presentationFigures/workflow4.png')
```

- *Run analyses*: such as regression analysis, logit analysis, mixed models, show gaps, calculate achievement levels, correlate variables, calculate percentiles.

_Example functions_:
- `achievementLevels`, `percentile`
- `cor.sdf`
- `gap`
- `lm.sdf`, `glm.sdf`
- `mvrlm.sdf`, `mixed.sdf`

---


One-stop Shop for NCES Survey Analysis
========================================================

```{r, echo=FALSE, out.width='50%', out.height='50%'}
knitr::include_graphics('presentationFigures/EdSurveyWorkflowFull.png')
```

- Related Documentation - [EdSurvey.pdf](https://www.air.org/sites/default/files/Edsurvey.pdf), [Chap 3, EdSurvey Book](https://naep-research.airprojects.org/Portals/0/EdSurvey_A_Users_Guide/_book/philosophyOfAnalysis.html)

---

Meet Your Data - print
========================================================

**`print()`**

- Print returns detailed data file information:

.codeScroll20[
```{r print SDF}
print(sdf)
```
]

<br>

---

Meet Your Data - dim
========================================================

**`dim()`**

- Returns the dimensions of the student data set:

```{r dim}
dim(sdf)
```

---

Meet Your Data - colnames
========================================================

**`colnames()`**

- Prints the names of all variables in the student and school data sets:

.codeScroll20[.code60[
```{r names}
colnames(sdf)
```
]]

---

Meet Your Data - searchSDF
========================================================

**`searchSDF()`** - Search the survey data frame by character strings

```{r searchSDF}
searchSDF("education", sdf)
```

- Add argument `levels = TRUE` to return variable levels.

.codeScroll10[
```{r searchSDF_student}
searchSDF("b003501", sdf, levels = TRUE)
```
]

- What occurs with an empty string?

```{r searchSDF_empty string, eval=FALSE}
searchSDF("", sdf)
```

---

Meet Your Data - levelsSDF
========================================================

**`levelsSDF()`**

- Show the levels of a variable

```{r levelsSDF}
levelsSDF("b018201", sdf)
```

---

Meet Your Data - showCodebook
========================================================

**`showCodebook()`**

- Show the levels of a variable

.codeScroll20[
```{r showCodebook}
showCodebook(sdf)
```
]

- `View()` shows a preview of a selected data set

```{r showCodebookView, eval = FALSE}
View(showCodebook(sdf))
```

---


Meet Your Data - showPlausibleValues
========================================================

**`showPlausibleValues()`** - Prints all plausible values

.codeScroll15[
```{r SPV and SW}
showPlausibleValues(sdf)
```
]

- add `verbose = TRUE`

.codeScroll10[
```{r SPVverbose}
showPlausibleValues(sdf, verbose = TRUE)
```
]

---

Meet Your Data - showWeights
========================================================

**`showWeights()`** - Prints all weights:

```{r SW}
showWeights(sdf)
```

- add `verbose = TRUE` to print the complete list of jackknife replicate weights associated with each full sample weight.

```{r SWverbose}
showWeights(sdf, verbose = TRUE)
```

---

Meet Your Data - Omitted Levels
========================================================

- Levels of the variables that will be omitted by default from the `edsurvey.data.frame`

```{r, echo=FALSE}
knitr::include_graphics('presentationFigures/omittedLevels.png')
```

---

Meet Your Data - Default Conditions
========================================================

- Special considerations for a particular `edsurvey.data.frame`

```{r, echo=FALSE}
knitr::include_graphics('presentationFigures/defaultConditions.png')
```

---


class: inverse, section-slide

Data Manipulation
========================================================
<hr class="sectionSlide">
.logoSection[
```{r, echo=FALSE, out.width='80%', out.height='80%'}
knitr::include_graphics('presentationFigures/naepLogo.png')
```
]


---

EdSurvey Calls Network Connection
========================================================

**Small Memory Footprint**


```{r, echo=FALSE,out.width='200%', out.height='200%'}
knitr::include_graphics('presentationFigures/data_footprint.png')
```
	
---

Data Manipulation - getData
========================================================

**`getData()`:** reads in selected variables and sampling weights from the EdSurvey database and returns a `light.EdSurvey.data.frame` (a data frame like object) into the Global environment.

*Functionality*

- Retrieve variables by call.
- Manipulate the resulting `light.EdSurvey.data.frame`:
  - Subset.
  - Recode.
  - Drop levels.
- Use `EdSurvey` package functions on `light.EdSurvey.data.frames`.


- Related Documentation - [getData.pdf](https://www.air.org/sites/default/files/EdSurvey-getData.pdf), [Chap 9, EdSurvey Book](https://naep-research.airprojects.org/Portals/0/EdSurvey_A_Users_Guide/_book/analysisOutsideEdSurvey.html)

---

Data Manipulation - getData
========================================================

**`getData()`**

```{r getData}
gddat <- getData(sdf, varnames = c('dsex', 'sdracem', 'b018201', 'b017451',
                                   'composite', 'geometry', 'origwt'),
              addAttributes = TRUE, omittedLevels = FALSE)
```

NAEP mathematics composite scale scores of 8th grade students

- A vector of variable names, including `dsex` (Gender), `sdracem` (Race/ethnicity), `b018201` (Language other than English spoken in home) and `b017451` (Frequency of talk about studies at home)
- Overall math performance across subscales (`composite`) and five others associated with `geometry`
- The sampling weight for this dataframe: `origwt`

---

Data Manipulation - getData
========================================================

Output:

.codeScroll25[
```{r View gddat}
# Note: head returns the first 6 rows of a data frame
head(gddat)
```
]

---

Data Manipulation - getData
========================================================

**`getData()`**

```{r getData2}
gddat <- getData(sdf, varnames = c('dsex', 'sdracem', 'b018201', 'b017451',
                                   'composite', 'geometry', 'origwt'),
              addAttributes = TRUE, omittedLevels = FALSE)
```

- A few important things to note:
  - "`addAttributes = TRUE`" allows the data.frame to be passed to `EdSurvey` package functions
  - all of the jackknife replicates are automatically returned (`srwt01` to `srwt62`)
  - "`omittedLevels = FALSE`" returns variables with special values (such as multiple entries or NA's) and manipulated by the user

---

Data Manipulation - subset
========================================================

**`subset()`**: Returns only the data matching elements from a variable

- Subset the connection to the data for all analyses:

```{r subsetDat}
subsetSDF <- subset(sdf, dsex %in% c("Male"))
```

- As expected the `subsetSDF` contains about half of the rows as the original:

```{r subsetDat Dimensions}
dim(sdf)
dim(subsetSDF)
```

---


Data Manipulation - recode.sdf
========================================================

**`recode.sdf()`** is used to recode the levels of a variable

- collapse or rename values

```{r recodeSDF}
sdf2 <- recode.sdf(sdf, recode =
                     list(b017451 = list(from = c("Never or hardly ever", "Once every few weeks"),
                                         to = c("Infrequently")),
                          b017451 = list(from = c("Every day"),
                                        to = c("Frequently")))
                   )
searchSDF("b017451", sdf2, levels = TRUE)
```

---

Data Manipulation - rename.sdf
========================================================

**`rename.sdf()`** is used to rename variables

```{r renameSDF}
sdf2 <- rename.sdf(sdf2, oldnames = "b017451",
                   newnames = "studytalkfrequency")
searchSDF("studytalkfrequency", sdf2, levels = TRUE)
```

